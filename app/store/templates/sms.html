{% extends "base.html" %}

{% block title %}Consulta de SMS{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('store_bp.static', filename='css/sms.css') }}">
  <meta name="csrf_token" content="{{ csrf_token() }}">
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('store_bp.static', filename='js/sms_configs.js') }}" defer></script>
  <script src="{{ url_for('store_bp.static', filename='js/sms_list.js') }}" defer></script>
  <script src="{{ url_for('store_bp.static', filename='js/sms_numbers.js') }}" defer></script>
{% endblock %}

{% block content %}

<div id="sms-management-container" class="form-container-large">
  <div class="admin-card">
    <div class="d-flex align-items-center flex-wrap gap-1 mb-1 justify-content-between">
      <h2 class="m-0 no-shrink">Consulta de SMS</h2>
      <div>
        <button 
          id="btnVolverPanel" 
          type="button" 
          class="btn-blue"
          data-url="{{ url_for('store_bp.admin_store') }}"
        >
          Volver
        </button>
      </div>
    </div>

    <hr class="hr-margin-15">
    <h3 class="mb-05 text-center">Búsqueda y Eliminación de Correos</h3>
    <form id="searchNumbersForm" name="searchNumbersForm">
      <label for="searchNumbersInput" class="sr-only">Buscar y eliminar correos</label>
      <textarea id="searchNumbersInput" rows="2" class="flex-grow-1 resize-vertical" placeholder="Ingresa uno o varios correos (separados por comas, espacios o saltos de línea)." autocomplete="off"></textarea>
      <button type="submit" class="btn-search">Limpiar</button>
    </form>
    <div id="numbersSearchResults" class="search-results-container">
        <!-- Resultados aquí -->
    </div>
    <div class="d-flex justify-content-between align-items-center min-height-2-5rem">
      <div id="searchStatus" class="text-italic text-secondary"></div>
      <div id="delete-displayed-container">
          <button id="deleteDisplayedBtn" class="btn-red btn-small d-none">
              Eliminar X Mostrados
          </button>
      </div>
    </div>
  </div>

  <div class="admin-card">
    <div id="allowedNumbersContainer" class="mb-0">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-1 mb-05">
        <div><strong>Lista Correos permitidos:</strong></div>
        <div class="d-flex align-items-center gap-05">
          <label for="perPageSelectNumbers"><strong>Mostrar:</strong></label>
          <select id="perPageSelectNumbers" class="select-padding-3px" autocomplete="off">
             <option value="10" selected>10</option><option value="20">20</option><option value="30">30</option><option value="50">50</option><option value="100">100</option><option value="300">300</option><option value="-1">Todos</option>
          </select>
        </div>
      </div>
      <div id="allowedNumbersTextContainer" class="allowed-emails-display">
        <p>Cargando correos...</p>
      </div>
      <div id="allowedNumbersPagination" class="d-flex justify-content-between align-items-center">
        <span id="paginationInfoNumbers"></span>
        <button id="deleteAllNumbersBtn" class="btn-panel btn-red btn-sm" title="Eliminar TODOS los correos permitidos">
          <i class="fas fa-trash"></i> Eliminar Todos
        </button>
        <div class="ml-auto">
          <button id="prevPageBtnNumbers" class="btn-panel btn-blue" disabled>&lt; Anterior</button>
          <button id="nextPageBtnNumbers" class="btn-panel btn-blue ml-05" disabled>Siguiente &gt;</button>
        </div>
      </div>
      
      <hr class="hr-margin-15">
      
      <div id="addNumbersSection" class="mb-0">
        <label for="newNumbersInput" class="sr-only">Nuevos Correos</label>
        <textarea id="newNumbersInput" name="new_numbers_input" rows="2" class="d-block mx-auto mt-05 mb-05 textarea-wide" placeholder="Ingresa uno o varios correos (separados por comas, espacios o saltos de línea). Ejemplo: correo1@gmail.com, correo2@gmail.com..." autocomplete="off"></textarea>
        <div class="text-center">
          <button type="button" id="addNumbersBtn" class="btn-blue">Añadir Correos</button>
        </div>
        <div class="text-center mt-05">
          <span id="addNumbersMsg" class="text-italic text-success"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="admin-card">
    <!-- Sección de Gestión de Números SMS -->
    <div id="sms-configs-section" class="mb-2">
      <h4 class="mb-1 text-center">Gestionar Números SMS</h4>
      
      <!-- Formulario para crear configuración -->
      <form id="sms-config-form" class="mb-2">
        
        <label for="sms-config-name" class="sr-only">Nombre</label>
        <input
          type="text"
          id="sms-config-name"
          placeholder="Nombre (obligatorio)"
          required
          class="d-block mb-05"
          autocomplete="off"
        >
        
        <label for="sms-config-account-sid" class="sr-only">Twilio Account SID</label>
        <input
          type="text"
          id="sms-config-account-sid"
          placeholder="Twilio Account SID (obligatorio)"
          required
          class="d-block mb-05"
          autocomplete="off"
        >
        
        <label for="sms-config-auth-token" class="sr-only">Twilio Auth Token</label>
        <input
          type="password"
          id="sms-config-auth-token"
          placeholder="Twilio Auth Token (obligatorio)"
          required
          class="d-block mb-05"
          autocomplete="off"
        >
        
        <label for="sms-config-phone" class="sr-only">Número de Teléfono</label>
        <input
          type="text"
          id="sms-config-phone"
          placeholder="Número de Teléfono (obligatorio, ej: +12672441170)"
          required
          class="d-block mb-05"
          autocomplete="off"
        >
        
        <div class="text-center d-flex gap-05 justify-content-center">
          <button type="submit" id="sms-config-save-btn" class="btn-green">Crear</button>
          <button type="button" id="test-number-states-btn" class="btn-blue">Probar Estado de Números</button>
        </div>
        
        <div id="sms-config-message" class="mt-05"></div>
      </form>
      
      <!-- Lista de configuraciones existentes -->
      <div id="sms-configs-list" class="mb-2">
        <p class="text-center">Cargando configuraciones...</p>
      </div>
    </div>
    
    <hr class="hr-margin-15">
    
    <div class="mb-1 d-flex gap-05 justify-content-center align-items-center sms-controls-row">
      <select id="sms-number-select" class="sms-select-width" autocomplete="off">
        <option value="">-- Selecciona un número --</option>
      </select>
    </div>
    
    <div class="mb-1 d-flex gap-05 justify-content-center align-items-center sms-controls-row">
      <label for="sms-search-input" class="sr-only">Buscar mensajes SMS</label>
      <input 
        type="text" 
        id="sms-search-input" 
        class="sms-input-width" 
        placeholder="Buscar por nombre o dejar vacío para ver todo"
        autocomplete="off"
      >
      <button type="button" id="btn-refresh-messages" class="btn-blue">
        <i class="fas fa-search"></i> Buscar
      </button>
      <button type="button" id="btn-cleanup-sms" class="btn-red" title="Eliminar mensajes antiguos (más de 15 minutos) y huérfanos">
        <i class="fas fa-trash"></i>
      </button>
    </div>
    
    <div id="sms-messages-container" class="mt-3">
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
      </div>
    </div>
  </div>
</div>

<!-- Modal para editar configuración SMS -->
<div id="sms-edit-config-modal" class="modal d-none" tabindex="-1">
  <div class="sms-modal-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="m-0 text-center flex-grow-1">Editar Configuración SMS</h4>
      <button type="button" class="btn-panel btn-red" id="close-edit-config-modal" title="Cerrar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form id="sms-edit-config-form">
      <input type="hidden" id="edit-sms-config-id" value="">
      
      <label for="edit-sms-config-name" class="sr-only">Nombre</label>
      <input
        type="text"
        id="edit-sms-config-name"
        placeholder="Nombre (obligatorio)"
        required
        class="d-block mb-05"
        autocomplete="off"
      >
      
      <label for="edit-sms-config-account-sid" class="sr-only">Twilio Account SID</label>
      <input
        type="text"
        id="edit-sms-config-account-sid"
        placeholder="Twilio Account SID (obligatorio)"
        required
        class="d-block mb-05"
        autocomplete="off"
      >
      
      <label for="edit-sms-config-auth-token" class="sr-only">Twilio Auth Token</label>
      <input
        type="password"
        id="edit-sms-config-auth-token"
        placeholder="Twilio Auth Token (opcional, déjalo vacío para mantener el actual)"
        class="d-block mb-05"
        autocomplete="off"
      >
      
      <label for="edit-sms-config-phone" class="sr-only">Número de Teléfono</label>
      <input
        type="text"
        id="edit-sms-config-phone"
        placeholder="Número de Teléfono (obligatorio, ej: +12672441170)"
        required
        class="d-block mb-05"
        autocomplete="off"
      >
      
      <div class="mt-3 text-center">
        <button type="submit" id="update-sms-config-btn" class="btn-green">Actualizar</button>
      </div>
      
      <div id="edit-sms-config-message" class="mt-05"></div>
    </form>
  </div>
</div>

<!-- Modal para ver mensaje completo -->
<div id="sms-message-modal" class="modal d-none" tabindex="-1">
  <div class="sms-modal-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="m-0 text-center flex-grow-1">Detalles del Mensaje</h4>
      <button type="button" class="btn-close" id="close-sms-modal"></button>
    </div>
    
    <div id="sms-message-details">
      <!-- Contenido dinámico -->
    </div>
    
    <div class="mt-3 text-center">
      <button type="button" id="close-sms-modal-btn" class="btn-panel btn-red">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal para gestionar Regex de SMS Config -->
<div id="sms-regex-modal" class="modal d-none" tabindex="-1">
  <div class="sms-modal-content admin-card">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <h4 class="m-0 text-center flex-grow-1">Gestionar Regex para SMS</h4>
      <button type="button" class="btn-panel btn-red" id="close-regex-modal" title="Cerrar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div id="sms-regex-config-name" class="mb-1 text-center font-weight-bold"></div>
    
    <hr class="hr-margin-15">
    
    <!-- Formulario para crear nuevo regex -->
    <div class="mb-2 regex-form-container">
      <label for="new-regex-name" class="sr-only">Nombre del regex</label>
      <input type="text" id="new-regex-name" placeholder="Nombre del regex" class="d-block mb-05 w-100" autocomplete="off">
      <label for="new-regex-pattern" class="sr-only">Patrón regex</label>
      <input type="text" id="new-regex-pattern" placeholder="Patrón regex (ej: código|code)" class="d-block mb-05 w-100" autocomplete="off">
      <div class="text-center mt-1">
        <button type="button" id="create-regex-btn" class="btn-green btn-sm">Crear Regex</button>
      </div>
    </div>
    
    <div class="mb-2">
      <label><strong>Regex disponibles:</strong></label>
      <div id="sms-regex-list" class="mb-2 regex-list-container">
        <p class="text-center text-secondary">Cargando regex...</p>
      </div>
    </div>
    
    <div id="sms-regex-message" class="mt-05"></div>
  </div>
</div>

<!-- Modal para editar Regex -->
<div id="sms-regex-edit-modal" class="modal d-none" tabindex="-1">
  <div class="sms-modal-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="m-0 text-center flex-grow-1">Editar Regex</h4>
      <button type="button" class="btn-panel btn-red" id="close-edit-regex-modal" title="Cerrar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form id="edit-regex-form">
      <input type="hidden" id="edit-regex-id" value="">
      
      <label for="edit-regex-name" class="sr-only">Nombre</label>
      <input type="text" id="edit-regex-name" placeholder="Nombre del regex" class="d-block mb-05 w-100" required autocomplete="off">
      
      <label for="edit-regex-pattern" class="sr-only">Patrón</label>
      <input type="text" id="edit-regex-pattern" placeholder="Patrón regex" class="d-block mb-05 w-100" required autocomplete="off">
      
      <div class="text-center mt-2">
        <button type="submit" id="update-regex-btn" class="btn-green">Actualizar</button>
      </div>
      
      <div id="edit-regex-message" class="mt-05"></div>
    </form>
  </div>
</div>
{% endblock %}


