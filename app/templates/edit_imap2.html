<!-- app/templates/edit_imap2.html -->
{% extends "base.html" %}
{% block content %}
{# Aplicada clase de contenedor #}
<div class="form-container-medium">
  <div class="card">
    <h2 class="text-center">Editar Servidor IMAP Segunda Página</h2>

    <!-- Formulario para actualizar un servidor IMAP2 existente -->
    <form method="POST"
          action="{{ url_for('admin_bp.manage_imap2') }}">
      <!-- Campo oculto con CSRF -->
      <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
      
      <!-- Campo oculto para indicar que se está editando el servidor con ID 'srv.id' -->
      <input type="hidden" name="server_id" value="{{ srv.id }}">

      <!-- Host con label y autocomplete -->
      <label for="host">Host del servidor:</label>
      <input
        type="text"
        id="host"
        name="host"
        placeholder="Host"
        value="{{ srv.host }}"
        required
        class="d-block mb-05"
        autocomplete="off"
      >

      <!-- Port con label y autocomplete -->
      <label for="port">Puerto:</label>
      <input
        type="number"
        id="port"
        name="port"
        placeholder="993"
        value="{{ srv.port }}"
        class="d-block mb-05"
        autocomplete="off"
      >

      <!-- Usuario con label y autocomplete -->
      <label for="username">Usuario:</label>
      <input
        type="text"
        id="username"
        name="username"
        placeholder="Usuario"
        value="{{ srv.username }}"
        required
        class="d-block mb-05"
        autocomplete="username"
      >

      <!-- Password con label y autocomplete -->
      <label for="password">Contraseña:</label>
      <input
        type="password"
        id="password"
        name="password"
        placeholder="Password (dejar vacío si no cambias)"
        class="d-block mb-05"
        autocomplete="current-password"
      >

      <!-- Carpetas con label y autocomplete -->
      <label for="folders">Carpetas (separadas por comas):</label>
      <input
        type="text"
        id="folders"
        name="folders"
        value="{{ srv.folders if srv.folders else 'INBOX' }}"
        class="d-block mb-05"
        autocomplete="off"
      >

      <!-- Ruta de acceso (route_path) -->
      <label for="route_path">Ruta de acceso (ej: /pagina2, /web):</label>
      <input
        type="text"
        id="route_path"
        name="route_path"
        placeholder="/pagina2"
        value="{{ srv.route_path if srv.route_path else '' }}"
        class="d-block mb-05"
        autocomplete="off"
      >
      <small class="text-secondary">Esta será la URL para acceder a esta página de códigos (ej: pagina.com{{ srv.route_path if srv.route_path else '/pagina2' }})</small>

      <div class="text-center mt-1">
        <button type="submit" class="btn-green mr-05">Guardar</button>
        <a href="{{ url_for('admin_bp.dashboard') }}" class="btn btn-blue text-decoration-none">Volver</a>
      </div>
    </form>

    <!-- Div para editar párrafo -->
    <div class="mt-2">
      <h3 class="text-center mb-05">Párrafo Personalizado</h3>
      <form id="saveParagraphForm" action="{{ url_for('admin_bp.update_imap2_paragraph', server_id=srv.id) }}" method="POST">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
        <label for="paragraph" class="sr-only">Contenido del párrafo:</label>
        <textarea
          id="paragraph"
          name="paragraph"
          rows="3"
          class="d-block w-100 resize-vertical mb-05"
          autocomplete="off"
        >{{ srv.paragraph if srv.paragraph else '' }}</textarea>
        <div class="text-center">
          <button type="submit" class="btn-green">Guardar Párrafo</button>
        </div>
      </form>
    </div>

    <!-- Div para tabla de Filtros y Regex -->
    <div class="mt-2">
      <h3 class="text-center mb-05">Filtros y Expresiones Regulares</h3>
      <div class="table-responsive">
        <table class="imap2-filters-regex-table">
          <thead>
            <tr>
              <th>Filtros</th>
              <th>Activar</th>
              <th>Regex</th>
              <th>Activar</th>
            </tr>
          </thead>
          <tbody id="filtersRegexTableBody">
            {% set max_rows = [all_filters|length, all_regexes|length]|max %}
            {% for i in range(max_rows) %}
              <tr>
                <!-- Columna Filtros -->
                <td>
                  {% if i < all_filters|length %}
                    <span class="filter-keyword">{{ all_filters[i].keyword }}</span>
                  {% endif %}
                </td>
                <!-- Columna Checkbox Filtros -->
                <td class="text-center">
                  {% if i < all_filters|length %}
                    <input
                      type="checkbox"
                      class="filter-checkbox"
                      data-filter-id="{{ all_filters[i].id }}"
                      data-server-id="{{ srv.id }}"
                      {% if all_filters[i].id in associated_filter_ids %}checked{% endif %}
                      autocomplete="off"
                    >
                  {% endif %}
                </td>
                <!-- Columna Regex -->
                <td>
                  {% if i < all_regexes|length %}
                    <div class="regex-info">
                      <div class="regex-description"><strong>{{ all_regexes[i].description if all_regexes[i].description else 'Sin descripción' }}</strong></div>
                      <div class="regex-pattern text-small text-secondary">{{ all_regexes[i].pattern }}</div>
                    </div>
                  {% endif %}
                </td>
                <!-- Columna Checkbox Regex -->
                <td class="text-center">
                  {% if i < all_regexes|length %}
                    <input
                      type="checkbox"
                      class="regex-checkbox"
                      data-regex-id="{{ all_regexes[i].id }}"
                      data-server-id="{{ srv.id }}"
                      {% if all_regexes[i].id in associated_regex_ids %}checked{% endif %}
                      autocomplete="off"
                    >
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="{{ url_for('static', filename='css/edit_imap2.css') }}">
<script src="{{ url_for('static', filename='js/edit_imap2.js') }}"></script>
{% endblock %}

