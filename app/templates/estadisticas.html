{% extends "base.html" %}

{% block title %}Estadísticas{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/store.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='fontawesome/css/all.css') }}">
{% endblock %}

{% block content %}
<div class="container container-max-width-900 store-light">

  <!-- MENÚ LATERAL MÓVIL PARA USUARIOS NORMALES -->
  <div id="mobileMenu" class="mobile-menu-store hidden">
    <div class="menu-title-row">
      <i class="fas fa-bars"></i>
      <h3>Menú</h3>
    </div>
    {% if current_user %}
      {% set show_store = False %}
      {% if session.get('username') == ADMIN_USER %}
        {% set show_store = True %}
      {% elif current_user.parent_id %}
        {% if current_user.can_access_store %}
          {% set parent = User.query.get(current_user.parent_id) %}
          {# Si el padre fue eliminado, parent será None #}
          {% if not parent %}
            {% set parent = None %}
          {% endif %}
          {% if parent and parent.roles_tienda and parent.roles_tienda[0].enabled %}
            {% set show_store = True %}
          {% endif %}
        {% endif %}
      {% elif current_user.roles_tienda and current_user.roles_tienda[0].enabled %}
        {% set show_store = True %}
      {% endif %}
      {% if show_store %}
        <a href="{{ url_for('store_bp.store_front') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-store"></i> Tienda</a>
        <a href="{{ url_for('store_bp.historial_compras_usuario') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-receipt"></i> Mi Historial de Compras</a>
      {% endif %}
    {% endif %}
    {% if current_user and current_user.has_public_tools_access() %}
      <a href="{{ url_for('store_bp.tools_public') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-tools"></i> Herramientas</a>
    {% endif %}
    <a href="{{ url_for('main_bp.home') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-code"></i> Códigos</a>
    {% if user_has_codigos2_access() %}
    <a href="{{ url_for('main_bp.home2') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-code"></i> Códigos 2</a>
    {% endif %}
    <a href="{{ url_for('user_auth_bp.estadisticas') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-chart-bar"></i> Estadísticas</a>
    {% if session.get('is_user') and current_user %}
      {% if current_user.is_support %}
        <a href="{{ url_for('store_bp.support_dashboard') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-headset"></i> Chat de Soporte Admin</a>
      {% elif current_user.can_chat %}
        <a href="{{ url_for('store_bp.user_chat_soporte') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-headset"></i> Chat de Soporte</a>
      {% endif %}
    {% endif %}
    {% if session.get('is_user') and current_user and current_user.can_create_subusers %}
      <a href="{{ url_for('subuser_bp.manage_subusers') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-users"></i> Sub-usuarios</a>
    {% endif %}
    {% if session.get('is_user') and not current_user.parent_id and user_has_worksheet_access(current_user) %}
  <a href="{{ url_for('store_bp.user_work_sheets') }}" class="btn-panel btn-blue mobile-menu-btn mb-04"><i class="fas fa-table"></i> Hojas de Cálculo</a>
{% endif %}
    {% if session.get('is_user') %}
      <a href="{{ url_for('user_auth_bp.logout') }}" class="btn-panel btn-red mobile-menu-btn mb-04"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
    {% else %}
      <a href="{{ url_for('user_auth_bp.logout') }}" class="btn-panel btn-red mobile-menu-btn mb-04"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
    {% endif %}
  </div>

  <div id="menuOverlay" class="menu-overlay"></div>

  <div class="admin-card">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <div class="d-flex gap-05">
        <button id="menuToggleBtn" class="btn-panel btn-blue menu-toggle-btn">&#9776; Menú</button>
      </div>
    </div>

    <h2 class="text-center mb-3">Estadísticas (Últimos 3 Meses)</h2>
    
    <!-- Tabs para cambiar entre resumen y lista -->
    <div class="d-flex justify-content-center mb-3 gap-2">
      <button id="tabResumen" class="btn-panel btn-blue estadisticas-tab active">Resumen</button>
      <button id="tabLista" class="btn-panel btn-blue estadisticas-tab">Lista</button>
    </div>
    
    <!-- Vista de Resumen -->
    <div id="vistaResumen" class="estadisticas-vista">
      <div class="row g-3 mb-3">
        <!-- Total Gastado -->
        <div class="col-md-6">
          <div class="estadistica-card">
            <div class="estadistica-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="estadistica-content">
              <h3 class="estadistica-label">Total Gastado</h3>
              <p class="estadistica-valor">${{ "{:,.2f}".format(total_gastado) }}</p>
            </div>
          </div>
        </div>
        
        <!-- Total Compras -->
        <div class="col-md-6">
          <div class="estadistica-card">
            <div class="estadistica-icon"><i class="fas fa-shopping-cart"></i></div>
            <div class="estadistica-content">
              <h3 class="estadistica-label">Total de Compras</h3>
              <p class="estadistica-valor">{{ total_compras }}</p>
            </div>
          </div>
        </div>
        
        <!-- Promedio por Compra -->
        <div class="col-md-6">
          <div class="estadistica-card">
            <div class="estadistica-icon"><i class="fas fa-chart-line"></i></div>
            <div class="estadistica-content">
              <h3 class="estadistica-label">Promedio por Compra</h3>
              <p class="estadistica-valor">${{ "{:,.2f}".format(promedio_compra) }}</p>
            </div>
          </div>
        </div>
        
        <!-- Período -->
        <div class="col-md-6">
          <div class="estadistica-card">
            <div class="estadistica-icon"><i class="fas fa-calendar-alt"></i></div>
            <div class="estadistica-content">
              <h3 class="estadistica-label">Período</h3>
              <p class="estadistica-valor">Últimos 3 meses</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Gasto por Mes -->
      {% if gasto_por_mes %}
      <div class="estadistica-seccion mb-4">
        <h3 class="mb-3"><i class="fas fa-chart-bar"></i> Gasto por Mes</h3>
        <div class="gasto-mes-container">
          {% for mes_data in gasto_por_mes %}
          <div class="gasto-mes-item">
            <div class="gasto-mes-label">{{ mes_data.mes_corto }}</div>
            <div class="gasto-mes-bar-container">
              <div class="gasto-mes-bar" data-porcentaje="{{ mes_data.porcentaje }}"></div>
            </div>
            <div class="gasto-mes-valor">${{ "{:,.2f}".format(mes_data.gasto) }}</div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      
      <!-- Productos Más Comprados -->
      {% if productos_top %}
      <div class="estadistica-seccion">
        <h3 class="mb-3"><i class="fas fa-star"></i> Productos Más Comprados</h3>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>#</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Total Gastado</th>
              </tr>
            </thead>
            <tbody>
              {% for producto in productos_top %}
              <tr>
                <td>{{ loop.index }}</td>
                <td><i class="fas fa-ticket-alt"></i> {{ producto.name }}</td>
                <td>{{ producto.total_cantidad }}</td>
                <td>${{ "{:,.2f}".format(producto.total_gastado) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
    
    <!-- Vista de Lista -->
    <div id="vistaLista" class="estadisticas-vista hidden">
      {% if compras_detalladas %}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Fecha</th>
              <th><i class="fas fa-ticket-alt"></i> Producto</th>
              <th>Cantidad</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for compra in compras_detalladas %}
            <tr>
              <td>{{ compra.fecha_corta }}</td>
              <td>{{ compra.producto }}</td>
              <td>{{ compra.cantidad }}</td>
              <td>${{ "{:,.2f}".format(compra.total) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-4">
        <i class="fas fa-inbox fa-3x mb-3 opacity-30"></i>
        <p>No tienes compras en los últimos 3 meses.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/menu_busqueda.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/estadisticas.js') }}" defer></script>
{% endblock %} 